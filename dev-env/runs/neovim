#!/usr/bin/env bash

# ‚òùÔ∏è Shebang: Tells the system "use bash to run this file"
# Like adding "type": "module" in package.json

echo "------------------- dev-env/neovim -------------------"

# Exit on any error (like throwing an error in JS)
set -e

# Print each command before running it (helpful for debugging)
set -x

# - name: Get latest stable Neovim version
#   ansible.builtin.uri:
#     url: https://api.github.com/repos/neovim/neovim/releases/latest
#     return_content: true
#   register: neovim_release

echo "üì° Fetching latest Neovim version..."

# curl = fetch() in JavaScript
# -s = silent (no progress bar)
# -L = follow redirects
# Store response in a variable
RESPONSE=$(curl -sL https://api.github.com/repos/neovim/neovim/releases/latest)

# Extract tag_name from JSON using jq (like JSON.parse() then .tag_name)
# jq is a command-line JSON processor
NEOVIM_VERSION=$(echo "$RESPONSE" | jq -r '.tag_name')

echo "‚úì Found version: $NEOVIM_VERSION"

# - name: Git neovim
#   ansible.builtin.git:
#     repo: "https://github.com/neovim/neovim.git"
#     dest: "~/personal/neovim"
#     version: "{{ neovim_version }}"
#     depth: 1
#     force: true

echo "üîΩ Cloning Neovim repository..."
# Set destination path
# $HOME = environment variable (like process.env.HOME in Node.js)
NEOVIM_DIR="$HOME/personal/neovim"

# Remove existing directory if it exists (force: true)
# -rf = recursive + force (no confirmation)
rm -rf "$NEOVIM_DIR"

# Clone the repository
# --depth 1 = shallow clone (only latest commit)
# --branch = checkout specific versio
git clone \
	--depth 1 \
	--branch "$NEOVIM_VERSION" \
	https://github.com/neovim/neovim.git \
	"$NEOVIM_DIR"

echo "‚úì Repository cloned"

# - name: Install Neovim build dependencies
#   become: true
#   ansible.builtin.apt:
#     name:
#       - ninja-build
#       - gettext
#       - cmake
#     update_cache: true

echo "üìö Installing build dependencies..."

# sudo = become: true (run as root/admin)
# apt update = update package list (like npm update)
sudo apt update

# apt install -y = install packages
# -y = answer "yes" to all prompts (non-interactive)
sudo apt install -y \
  ninja-build gettext cmake unzip curl \
  build-essential git lua5.1 liblua5.1-0-dev luarocks
echo "‚úì Dependencies installed"

echo "üî® Building Neovim..."

# - name: Build Neovim from source
#   make:
#     chdir: "~/personal/neovim"
#     params:
#       CMAKE_BUILD_TYPE: "RelWithDebInfo"
#   register: build_result
#   ignore_errors: true

# cd = change directory (chdir in Ansible)
cd "$NEOVIM_DIR"

# Try to build, catch errors
# `if ! command; then` = If command fails, do this (like `if (!result)` in JS)
# || = "or" operator (if left fails, run right)
# This is like: try { make } catch { show error }
# `make CMAKE_BUILD_TYPE=RelWithDebInfo` = run make with that parameter
# `exit 1` = exit with error code (like throw new Error())
if ! make CMAKE_BUILD_TYPE=RelWithDebInfo; then
  # Build failed! Show helpful message
  echo "‚ùå Build failed! This usually means missing dependencies."
  echo ""
  echo "üîç To find what's needed:"
  echo "1. Check the error output above"
  echo "2. Visit: https://github.com/neovim/neovim/blob/$NEOVIM_VERSION/BUILD.md"
  echo "3. Or run: cat $NEOVIM_DIR/BUILD.md"
  echo ""
  echo "üí° Add missing packages to the script and re-run"
  exit 1  # Exit with error code (like throw new Error())
fi

echo "‚úì Build complete"

# - name: Install Neovim system-wide
#   become: true
#   make:
#     target: install
#     chdir: "~/personal/neovim"
echo "‚öôÔ∏è Installing Neovim system-wide..."

# sudo = become: true
# make install = install target
sudo make install

echo "‚úì Neovim installed!"
echo ""
echo "üéâ Done! Run 'nvim --version' to verify"
